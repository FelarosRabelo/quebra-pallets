<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Calculadora de Quebra de Pallets</title>
    <style>
        /* (O CSS permanece igual) */
        :root {
            --industrial-dark: #2f3640;
            --industrial-gray: #353b48;
            --industrial-accent: #e84118;
            --industrial-light: #dcdde1;
            --industrial-metal: #7f8fa6;
            --industrial-success: #44bd32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(232, 65, 24, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html {
            height: 100%;
            font-size: 16px;
        }

        body {
            background: linear-gradient(135deg, #485460 0%, #1e272e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            overscroll-behavior: none;
        }

        .industrial-panel {
            background: var(--industrial-dark);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            border: 1px solid #3d3d3d;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .industrial-header {
            background: var(--industrial-gray);
            color: white;
            padding: 25px 20px 20px;
            text-align: center;
            border-bottom: 3px solid var(--industrial-accent);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .industrial-header h1 {
            font-size: clamp(18px, 5vw, 22px);
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .industrial-subtitle {
            font-size: clamp(11px, 3vw, 13px);
            opacity: 0.8;
            font-weight: 400;
            margin-bottom: 15px;
        }

        .unit-controls {
            display: flex;
            background: #2c2c2c;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #444;
        }

        .unit-tab {
            flex: 1;
            padding: 14px 8px;
            text-align: center;
            color: var(--industrial-light);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: clamp(12px, 3.5vw, 14px);
            border-right: 1px solid #444;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(232, 65, 24, 0.3);
        }

        .unit-tab:last-child {
            border-right: none;
        }

        .unit-tab.active {
            background: var(--industrial-accent);
            color: white;
        }

        .unit-tab:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .industrial-body {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--industrial-light);
            font-size: clamp(13px, 4vw, 15px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .industrial-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #444;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #2c2c2c;
            color: white;
            font-weight: 500;
            -webkit-appearance: none;
            appearance: none;
            min-height: 52px;
            -webkit-user-select: text;
            user-select: text;
        }

        .industrial-input:focus {
            border-color: var(--industrial-accent);
            outline: none;
            background: #333;
            box-shadow: 0 0 0 3px rgba(232, 65, 24, 0.2);
        }

        .industrial-input::placeholder {
            color: #777;
        }

        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .specs-panel {
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .specs-title {
            color: var(--industrial-light);
            font-size: clamp(12px, 3.5vw, 14px);
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .specs-content {
            color: #bbb;
            font-size: clamp(12px, 3.5vw, 14px);
            line-height: 1.5;
        }

        .industrial-btn {
            width: 100%;
            padding: 18px;
            background: var(--industrial-accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: clamp(16px, 4.5vw, 18px);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(232, 65, 24, 0.3);
        }

        .industrial-btn:active {
            background: #c23616;
            transform: scale(0.98);
        }

        .results-display {
            background: #2c2c2c;
            border-top: 1px solid #444;
            padding: 20px;
            display: none;
        }

        .results-display.active {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculation-view {
            margin-bottom: 25px;
        }

        .view-title {
            color: var(--industrial-light);
            margin-bottom: 18px;
            font-size: clamp(15px, 4.5vw, 18px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #444;
            padding-bottom: 12px;
        }

        .formula-display {
            background: #333;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 18px;
            border-left: 4px solid var(--industrial-accent);
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: white;
            font-size: clamp(13px, 3.5vw, 15px);
            word-break: break-word;
        }

        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .step-display {
            padding: 16px;
            background: #333;
            border-radius: 10px;
            font-size: clamp(12px, 3.5vw, 14px);
            border-left: 3px solid var(--industrial-success);
            color: #ddd;
            line-height: 1.4;
        }

        .summary-display {
            background: var(--industrial-gray);
            color: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #444;
        }

        .summary-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: clamp(15px, 4.5vw, 18px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            border: 1px solid #444;
        }

        .summary-value {
            font-size: clamp(16px, 5vw, 20px);
            font-weight: 800;
            margin-top: 8px;
            color: white;
        }

        .summary-label {
            font-size: clamp(10px, 3vw, 12px);
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-indicator {
            background: var(--industrial-success);
            color: white;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: clamp(13px, 3.5vw, 15px);
        }

        .required-field::after {
            content: " *";
            color: var(--industrial-accent);
        }

        .weight-display {
            font-family: 'Courier New', monospace;
            font-weight: 700;
        }

        @supports (-webkit-touch-callout: none) {
            body {
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            .industrial-panel {
                max-height: 85vh;
            }
        }

        @media screen and (max-width: 320px) {
            .industrial-header,
            .industrial-body,
            .results-display {
                padding: 15px;
            }
            
            .summary-grid {
                gap: 10px;
            }
            
            .summary-item {
                padding: 15px 8px;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .unit-tab:hover {
                background: inherit;
            }
            
            .industrial-btn:hover {
                background: var(--industrial-accent);
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="industrial-panel">
        <div class="industrial-header">
            <h1>Calculadora de Quebra de Pallets</h1>
            <div class="industrial-subtitle">Sistema de Gerenciamento de Armazém</div>
            <div class="unit-controls">
                <div class="unit-tab active" data-unit="KG" onclick="selectUnit(this)" role="button" tabindex="0" aria-pressed="true">KG</div>
                <div class="unit-tab" data-unit="KGL" onclick="selectUnit(this)" role="button" tabindex="0" aria-pressed="false">KGL</div>
                <div class="unit-tab" data-unit="KGB" onclick="selectUnit(this)" role="button" tabindex="0" aria-pressed="false">KGB</div>
            </div>
        </div>

        <div class="industrial-body">
            <div class="input-group">
                <label for="tara" class="required-field">Peso do Tarugo (Unitário)</label>
                <input type="number" id="tara" step="0.001" value="0.510" placeholder="Ex: 0.510" class="industrial-input" inputmode="decimal">
            </div>

            <div class="input-group">
                <label for="peso_liquido_unitario" class="required-field">Peso Líquido da Bobina (Unitário)</label>
                <input type="number" id="peso_liquido_unitario" step="0.001" value="5.000" placeholder="Ex: 5.000" class="industrial-input" inputmode="decimal">
            </div>

            <div class="input-group">
                <label for="quantidade_pedido" id="label_quantidade_pedido" class="required-field">Peso Total para Venda</label>
                <input type="number" id="quantidade_pedido" step="0.001" value="3000" placeholder="Digite o peso total" class="industrial-input" inputmode="decimal">
            </div>

            <div class="specs-panel">
                <div class="specs-title">Especificações da Unidade</div>
                <div class="specs-content" id="unit-explanation">
                    <strong>KG:</strong> O valor de venda é tratado como Peso Líquido Total. A Tara é calculada e adicionada ao final.
                </div>
            </div>

            <button class="industrial-btn" id="calcular" onclick="calculate()" aria-label="Calcular volume">
                Calcular Volume
            </button>
        </div>

        <div class="results-display" id="results" aria-live="polite">
            <div class="calculation-view">
                <h3 class="view-title">Validação do Cálculo</h3>
                <div class="formula-display" id="formula">
                    Fórmula base será exibida aqui...
                </div>
                <div class="steps-container" id="calculation-steps">
                    <div class="step-display" id="step-unidades"></div>
                    <div class="step-display" id="step-tara"></div>
                    <div class="step-display" id="step-bruto"></div>
                </div>
            </div>

            <div class="summary-display">
                <h3 class="summary-title">Resumo Final</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Unidades Finais</div>
                        <div class="summary-value" id="bobinas">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Peso Líquido Total</div>
                        <div class="summary-value weight-display" id="peso-liquido-total">0 KG</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Peso Bruto Total</div>
                        <div class="summary-value weight-display" id="peso-bruto-total">0 KG</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Peso da Tara Total</div>
                        <div class="summary-value weight-display" id="peso-tara-total">0 KG</div>
                    </div>
                </div>
            </div>

            <div class="status-indicator">
                ✅ Cálculo Concluído - Volume Pronto para Processamento
            </div>
        </div>
    </div>

    <script>
        // CORREÇÕES PARA iOS - JavaScript mais compatível
        
        // Variáveis globais
        let currentUnit = 'KG';
        
        // Função para selecionar unidade
        function selectUnit(element) {
            // Remover classe active de todas as tabs
            var tabs = document.querySelectorAll('.unit-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
                tabs[i].setAttribute('aria-pressed', 'false');
            }
            
            // Adicionar classe active à tab clicada
            element.classList.add('active');
            element.setAttribute('aria-pressed', 'true');
            currentUnit = element.getAttribute('data-unit');
            
            // Atualizar interface
            updateUnitInterface();
            
            // Recalcular se houver valores
            var tara = document.getElementById('tara').value;
            var pesoLiquido = document.getElementById('peso_liquido_unitario').value;
            var quantidade = document.getElementById('quantidade_pedido').value;
            
            if (tara && pesoLiquido && quantidade) {
                calculate();
            }
        }
        
        // Função para atualizar a interface da unidade
        function updateUnitInterface() {
            var explanations = {
                'KG': '<strong>KG:</strong> O valor de venda é tratado como Peso Líquido Total. A Tara é calculada e adicionada ao final.',
                'KGL': '<strong>KGL:</strong> Similar ao KG (Quilo Líquido), o input é tratado como Peso Líquido Total. A Tara é calculada com base nas unidades finais.',
                'KGB': '<strong>KGB:</strong> O input é tratado como Peso Bruto Total. O Peso Líquido é determinado pela subtração da Tara.'
            };
            
            var labels = {
                'KG': 'Peso Total para Venda (Peso Líquido Total)',
                'KGL': 'Peso Total para Venda (Peso Líquido Total)',
                'KGB': 'Peso Total para Venda (Peso Bruto Total)'
            };
            
            document.getElementById('label_quantidade_pedido').textContent = labels[currentUnit];
            document.getElementById('unit-explanation').innerHTML = explanations[currentUnit];
        }
        
        // Função para formatar números
        function formatarPeso(valor) {
            return valor.toLocaleString('pt-BR', {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            });
        }
        
        // Função principal de cálculo
        function calculate() {
            console.log('Iniciando cálculo...');
            
            var tara = parseFloat(document.getElementById('tara').value);
            var pesoLiquidoUnitario = parseFloat(document.getElementById('peso_liquido_unitario').value);
            var quantidadePedido = parseFloat(document.getElementById('quantidade_pedido').value);

            // Validação
            if (isNaN(tara) || isNaN(pesoLiquidoUnitario) || isNaN(quantidadePedido)) {
                alert('Por favor, preencha todos os campos obrigatórios com valores numéricos.');
                return;
            }

            if (tara <= 0 || pesoLiquidoUnitario <= 0 || quantidadePedido <= 0) {
                alert('Todos os valores devem ser maiores que zero.');
                return;
            }

            var unidadesCalculadas, unidadesFinais, pesoLiquidoTotal, pesoBrutoTotal, pesoBrutoUnitario, pesoTaraTotal;
            var formulaText = '';
            var stepUnidadesText = '';
            var stepTaraText = '';
            var stepBrutoText = '';

            switch(currentUnit) {
                case 'KG':
                case 'KGL':
                    unidadesCalculadas = quantidadePedido / pesoLiquidoUnitario;
                    unidadesFinais = Math.ceil(unidadesCalculadas);
                    pesoLiquidoTotal = quantidadePedido;
                    pesoTaraTotal = unidadesFinais * tara;
                    pesoBrutoTotal = pesoLiquidoTotal + pesoTaraTotal;
                    pesoBrutoUnitario = pesoLiquidoUnitario + tara;
                    
                    formulaText = 'Unidades = Peso Líquido Total ÷ Peso Líquido Unitário';
                    stepUnidadesText = 'Cálculo das Unidades: ' + formatarPeso(quantidadePedido) + ' KG ÷ ' + formatarPeso(pesoLiquidoUnitario) + ' KG/unidade = ' + unidadesCalculadas.toFixed(6) + ' unidades → Arredondado para ' + unidadesFinais + ' unidades';
                    stepTaraText = 'Peso Tara Total: ' + unidadesFinais + ' unidades × ' + formatarPeso(tara) + ' KG/unidade = ' + formatarPeso(pesoTaraTotal) + ' KG';
                    stepBrutoText = 'Peso Bruto Total: ' + formatarPeso(pesoLiquidoTotal) + ' KG (Líquido) + ' + formatarPeso(pesoTaraTotal) + ' KG (Tara) = ' + formatarPeso(pesoBrutoTotal) + ' KG';
                    break;

                case 'KGB':
                    pesoBrutoUnitario = pesoLiquidoUnitario + tara;
                    unidadesCalculadas = quantidadePedido / pesoBrutoUnitario;
                    unidadesFinais = Math.ceil(unidadesCalculadas);
                    pesoBrutoTotal = quantidadePedido;
                    pesoTaraTotal = unidadesFinais * tara;
                    pesoLiquidoTotal = pesoBrutoTotal - pesoTaraTotal;
                    
                    formulaText = 'Unidades = Peso Bruto Total ÷ Peso Bruto Unitário';
                    stepUnidadesText = 'Cálculo das Unidades: ' + formatarPeso(quantidadePedido) + ' KG ÷ ' + formatarPeso(pesoBrutoUnitario) + ' KG/unidade = ' + unidadesCalculadas.toFixed(6) + ' unidades → Arredondado para ' + unidadesFinais + ' unidades';
                    stepTaraText = 'Peso Tara Total: ' + unidadesFinais + ' unidades × ' + formatarPeso(tara) + ' KG/unidade = ' + formatarPeso(pesoTaraTotal) + ' KG';
                    stepBrutoText = 'Peso Líquido Total: ' + formatarPeso(pesoBrutoTotal) + ' KG (Bruto) - ' + formatarPeso(pesoTaraTotal) + ' KG (Tara) = ' + formatarPeso(pesoLiquidoTotal) + ' KG';
                    break;
            }

            // Atualizar interface
            document.getElementById('formula').textContent = formulaText;
            document.getElementById('step-unidades').innerHTML = stepUnidadesText;
            document.getElementById('step-tara').innerHTML = stepTaraText;
            document.getElementById('step-bruto').innerHTML = stepBrutoText;

            document.getElementById('bobinas').textContent = unidadesFinais;
            document.getElementById('peso-liquido-total').textContent = formatarPeso(pesoLiquidoTotal) + ' KG';
            document.getElementById('peso-bruto-total').textContent = formatarPeso(pesoBrutoTotal) + ' KG';
            document.getElementById('peso-tara-total').textContent = formatarPeso(pesoTaraTotal) + ' KG';

            // Mostrar resultados
            document.getElementById('results').classList.add('active');
            
            console.log('Cálculo concluído com sucesso');
        }

        // Inicialização otimizada para iOS
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - inicializando...');
            
            // Configurar eventos de input para melhor resposta no iOS
            var inputs = ['tara', 'peso_liquido_unitario', 'quantidade_pedido'];
            
            for (var i = 0; i < inputs.length; i++) {
                var input = document.getElementById(inputs[i]);
                
                // Eventos para iOS
                input.addEventListener('input', function() {
                    if (this.value && parseFloat(this.value) <= 0) {
                        this.style.borderColor = '#e84118';
                    } else {
                        this.style.borderColor = '#444';
                    }
                });
                
                // Evento change para iOS
                input.addEventListener('change', function() {
                    calculate();
                });
            }
            
            // Calcular automaticamente após um pequeno delay
            setTimeout(function() {
                calculate();
            }, 500);
        });

        // Event listeners adicionais para melhor compatibilidade com iOS
        window.addEventListener('load', function() {
            console.log('Página totalmente carregada');
        });

        // Prevenir zoom em inputs no iOS
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>